#!/usr/bin/env php
<?php
/**
 * StoneScriptPHP CLI Tool
 * Like 'php artisan' for Laravel or 'ng' for Angular
 *
 * Usage: php stone <command> [options]
 */

// Detect installation mode
$isVendorMode = strpos(__DIR__, 'vendor/progalaxyelabs/stonescriptphp') !== false;

if ($isVendorMode) {
    // Installed via composer require - running from vendor/bin/stone
    $vendorDir = dirname(dirname(__DIR__));
    define('ROOT_PATH', dirname($vendorDir));
    define('FRAMEWORK_PATH', __DIR__ . '/Framework');
    define('IS_VENDOR_MODE', true);
} else {
    // Installed via composer create-project - running from project root
    define('ROOT_PATH', __DIR__);
    define('FRAMEWORK_PATH', ROOT_PATH . '/Framework');
    define('IS_VENDOR_MODE', false);
}

require_once ($isVendorMode ? $vendorDir : ROOT_PATH) . '/vendor/autoload.php';

// CLI Colors
class Color {
    const RED = "\033[0;31m";
    const GREEN = "\033[0;32m";
    const YELLOW = "\033[1;33m";
    const BLUE = "\033[0;34m";
    const NC = "\033[0m"; // No Color

    public static function red($text) { return self::RED . $text . self::NC; }
    public static function green($text) { return self::GREEN . $text . self::NC; }
    public static function yellow($text) { return self::YELLOW . $text . self::NC; }
    public static function blue($text) { return self::BLUE . $text . self::NC; }
}

// Available commands
$commands = [
    'new' => [
        'description' => 'Create new StoneScriptPHP project (like "ng new" for Angular)',
        'file' => 'cli/new.php',
    ],
    'init' => [
        'description' => 'Initialize StoneScriptPHP in existing project (after composer require)',
        'file' => 'cli/init.php',
    ],
    'setup' => [
        'description' => 'Interactive project setup (run after composer create-project)',
        'file' => 'cli/setup.php',
    ],
    'serve' => [
        'description' => 'Start development server',
        'handler' => 'serve',
    ],
    'generate' => [
        'description' => 'Generate code (route, model, migration, etc.)',
        'file' => 'cli/generate-route.php', // Dispatcher
    ],
    'migrate' => [
        'description' => 'Run database migrations',
        'file' => 'cli/migrate.php',
    ],
    'test' => [
        'description' => 'Run PHPUnit tests',
        'handler' => 'test',
    ],
    'env' => [
        'description' => 'Generate .env file',
        'file' => 'cli/generate-env.php',
    ],
    'cli-server' => [
        'description' => 'Start HTTP API server for code generation',
        'file' => 'cli/cli-server.php',
    ],
];

// Parse command
$command = $argv[1] ?? 'help';
$args = array_slice($argv, 2);

// Show help
if ($command === 'help' || $command === '--help' || $command === '-h') {
    echo Color::blue("StoneScriptPHP CLI Tool") . "\n\n";
    echo "Usage: php stone <command> [options]\n\n";
    echo "Available commands:\n";
    foreach ($commands as $cmd => $info) {
        printf("  %s%-12s%s %s\n", Color::GREEN, $cmd, Color::NC, $info['description']);
    }
    echo "\n";
    echo "Examples:\n";
    echo "  php stone new my-api             # Create new project\n";
    echo "  php stone setup                  # Interactive setup\n";
    echo "  php stone serve                  # Start dev server\n";
    echo "  php stone generate route login   # Generate login route\n";
    echo "  php stone migrate verify         # Check database drift\n";
    echo "\n";
    exit(0);
}

// Execute command
if (!isset($commands[$command])) {
    echo Color::red("Error: Unknown command '$command'") . "\n";
    echo "Run 'php stone help' for available commands\n";
    exit(1);
}

$cmdInfo = $commands[$command];

// Handle built-in commands
if (isset($cmdInfo['handler'])) {
    switch ($cmdInfo['handler']) {
        case 'serve':
            $port = $args[0] ?? 9100;
            echo Color::green("Starting server on http://127.0.0.1:$port") . "\n";
            echo "Press Ctrl+C to stop\n\n";
            passthru("php -S 127.0.0.1:$port -t public");
            break;

        case 'test':
            if (!file_exists('vendor/bin/phpunit')) {
                echo Color::red("PHPUnit not installed. Run: composer require --dev phpunit/phpunit") . "\n";
                exit(1);
            }
            passthru("vendor/bin/phpunit " . implode(' ', $args));
            break;
    }
    exit(0);
}

// Execute external CLI script
if (isset($cmdInfo['file'])) {
    $scriptPath = FRAMEWORK_PATH . '/' . $cmdInfo['file'];

    if (!file_exists($scriptPath)) {
        echo Color::red("Error: Command script not found: $scriptPath") . "\n";
        exit(1);
    }

    // Pass arguments to the script
    $_SERVER['argv'] = array_merge([$scriptPath], $args);
    $_SERVER['argc'] = count($_SERVER['argv']);

    require $scriptPath;
    exit(0);
}
